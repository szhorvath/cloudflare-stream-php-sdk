<?php

declare(strict_types=1);

use Szhorvath\CloudflareStream\Concerns\StreamSigner;

it('should return a signed token', function () {
    $keyId = 'acfe424f5031ac99ddca47b7037e3446';
    $pem = 'LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBeFZjNHNJd2htN1lxcmNIOGpWQW52ZDF4cmRNM2tsRTJtNjJCWXNYWG9PQWdXaWRhCmlPZVcydWxmV3JJRXhYWFZZeThSaDBKK0RhRHA2TlArTW5xT05hdFMyRVlEWENGQXEyNkdZNVdBNytjTmZmY2UKNjVINzlZWGxrc291N2tUalFWcndIMlE0cVdaaW8wN2FsY1Z6OHhVNTZDNHAxeTEyNzRtYVZJVGpLUEd1cW56OQp6dEFkK2U5NzN5bUtIMEY3d0tkbFBZTERxMS92b0lGT2FTZnZVT05PUlBTTlBSUHFEcjZIeG5maTVnYVljckMwCi9nUTZXNm1TT2UzS3ltb3ZqZlpxSXhMWVRya2JzbllEVG5Wb3FneVZpMzVOWGxhdUxIaXBaWTYxa1lTb0ZadEoKTTUxTnVCcVEyb1ZNQS9VNCs2S1FjbjdRMnBpblpiSHM4QzdJcXdJREFRQUJBb0lCQUIvV2xpVlp2blJlWEIxagpqa2tJVlJrYldLTm9UKzl4M2VNWkI2WjFiL2diSU8wYXEwOHFPaHNBaXV0WmpFNkZWOU9rUE9vN0xwWXBUNFBLCmJCa2R6OExWN014SzQzRGlSb3BDRHptUzNkWVd5NFQyc1V6bFpTYTBIeGxqT0ZZbDFCcHZ2d3o1Z1BESHZZTkcKamhxYTNEMnNQNGIzcDdWNU50YW50emdLcHBHc3YrL05EVm9uSnIrdEs4YVp2eUQzMFoxYmE2S2ZyODc1djFBUgo3SXhESVAyd3dVekJlT3BLcjFmZUh3bDhPK1ExWmw5YnllajhueXlVS1RVZEdPaUowTXMwWHpnYWYvMHcyTFkrCnhqb0xQdDBwZ0lzU0FiWTlPajVqekxGaG1WUkFUUFF4ZGhzZkRzK3hLYmM3cXh3bEU0di9WVlJaTUpFRzBQbkwKVVc2L2RxVUNnWUVBNGhzb2tYaEN0UWxlN2tJa3BIdjBDaG1BU1VNSDZmQk1Ra0xQNXd5MGhXcEUwTXB4cHF2UwpPZkNHUTBaY1NrK09GdFZkT1A2azVYRFVsb29pMysxU2N0RUhkNkV0c1g0V3JuRUgvazZFSU5teDlHZTl6czl5CmFpRjVsYjdjRWVkL1JPNVZGdEpTR1VuckR6blloak9HdmlXR2xYazZldUFmSFVFSmlzWjQydFVDZ1lFQTMyNTIKaFhieWZzVkFsWGFobk1HVWlmZ1hRMWhnVkJkMFVvcUR5VmNvQm02eGw5NXAwMVpNbXFRbGUxWTZQUmdSVThCegorMVREOW5uQm0yY3pBNTNZME5JcHI2ajl5Tmg3cEhHRG10QUtjRC9RbFRDRnM3dVRUWlJWdlY2RUx6d2NKQ0dQCjlqKzFYNjJicjNsOXptYlVKcmxUSTJjSGVHUEpEK2l0eHZFTDFYOENnWUJ0VTBSaVVndXZEVURoWXdua25pcDUKVjZzM3dUbHFXODREbTlwNmxTSVVBRFlWM2t6bGtkNnNOU2cyRHlkQXB3YkU4NVdIb1ZpSnQreVNmV2d2YmNpWAp5NG9ZeGM0YUxDVTdZMXZDRXFUQVhZSTE4cE5NRS9IMmJ3a2k1bzN4K2tVSFIxWE5HeFNuTlo1NlZqWGpiYmFRCjZnUVE4ZlRjeE5GR2k5UFpUZTNSb1FLQmdRQ2ViazZlanR5ZXBiSUpDYWpKWmI2MUluVWtiTnRKWmFRM0R6OHAKbXFLb0JQL3JCMndVem1IZFdiMjJPa3Rybk5CVWllZno5SVJNRnNRQk5PbElqRG44d0xtTWRKRVlST0ZQbHFwUwpNV2psZFdxckQxQVBSVmZMTC82b0hBZ3hFamVHSzBKUXc1WVJ0U0hyQ0lQN3dwQjJzUHpSNHJHNlhVOXA5M3laCno3eXJjd0tCZ0IzWFgrZG9JNWdWc0piaG1wbUoyd3ZOR0ZlbUhkT3NXUmtqZjZHUTlBdjdTNGg2NlNjaVF4R1cKSnlaQkJ5YkU0cWI3NE9iWU9Fbk43NlZiQjJSK0huQTdnRVdsSnU0WWh1UjRjL1gwMno2ekxlZGFGVXFQc0ZWUQppU05UcXdsVzhlWCs4MjAxaXQvUEhIc3dhSFZhcFhvVDdVRUNTeU5pdmRDWmFoNWhUMWVlCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==';

    $videoId = '143aaa0e8af3ed7d7f6cd173e5e01e6b';
    $expiresAt = new DateTimeImmutable('2024-12-01 00:00:00');
    $accessRules = [
        [
            'type' => 'ip.geoip.country',
            'action' => 'allow',
            'country' => ['GB'],
        ],
        [
            'type' => 'any',
            'action' => 'block',
        ],
    ];

    $streamSigner = new StreamSigner($pem, $keyId);

    $signedToken = $streamSigner
        ->accessRules($accessRules)
        ->downloadable()
        ->expires($expiresAt)
        ->availableFrom(new DateTimeImmutable('2024-10-01 00:00:00'))
        ->tokenFor($videoId);

    expect($signedToken)->toBe('eyJhbGciOiJSUzI1NiIsImtpZCI6ImFjZmU0MjRmNTAzMWFjOTlkZGNhNDdiNzAzN2UzNDQ2In0.eyJhY2Nlc3NSdWxlcyI6W3sidHlwZSI6ImlwLmdlb2lwLmNvdW50cnkiLCJhY3Rpb24iOiJhbGxvdyIsImNvdW50cnkiOlsiR0IiXX0seyJ0eXBlIjoiYW55IiwiYWN0aW9uIjoiYmxvY2sifV0sImRvd25sb2FkYWJsZSI6dHJ1ZSwiZXhwIjoxNzMzMDExMjAwLCJuYmYiOjE3Mjc3NDA4MDAsImtpZCI6ImFjZmU0MjRmNTAzMWFjOTlkZGNhNDdiNzAzN2UzNDQ2Iiwic3ViIjoiMTQzYWFhMGU4YWYzZWQ3ZDdmNmNkMTczZTVlMDFlNmIifQ.UL0p9kTZ2EU2TMwRs4OKwJpE9Bej481GIU7EKgYeSsD0CAYFWinc6fDTpvbEIb9HR5Gng0bm7V5AtGTyomOXlBAjewG4cH7ghwHOJFZF2PhqACXWn6m2076b5P9fceq0E7Eg8GxZS1kXCij4_lOG3dfvNAJftEznQFBf5TzHV796-O0TRD144smYrATPLlHlf8cn9OyuMz2LA9oQec-lZ71TVtT3P2AF84VEW-Yom_Nw9MpmRhouDJrOkshXACqhYu1Rrg8bhHV8HUjmq7xG2QRN8uacjmaVAAYykpRm021Hvyo5ceZWETCrvnX4LzIyuS4DzLk2QB6lCPDDWuQ-_A');
});
